#FCC Peak and 24-hour Period Sustained Throughput Calculations

This document describes how the FCC uses SamKnows data to calculate the actual peak and 24-hour period sustained throughput per ISP. The calculations are based on data collected from the SamKnows testers (known as panelists) each of whom are associated with an ISP and a service tier. After the data are collected, the FCC passes this raw data through several levels of analysis to arrive at the actual peak and 24-hour period sustained throughput per ISP. 

Each participating panelist receives a piece of network equipment that periodically performs a set of tests on their network connection. Of these tests, one measures a user's HTTP upload and download speeds (burst and sustained). In the test, a user uploads/downloads a particular chunk of data to/from a network server and records the throughput rate every five seconds for the duration of the test. Each five second slice of the test is known as a sequence and is given a number. SamKnows designed the tests to take approximately 30 seconds which means that there are usually 6 sequences (numbered 0-5) per test. SamKnows defines the burst rate as the throughput achieved during the 0th sequence and the sustained rate as the throughput achieved during 5th sequence. For more technical details about the test, please see the [Measuring Broadband America Report Technical Appendix](http://transition.fcc.gov/cgb/measuringbroadbandreport/2012/Technical-Appendix.pdf) sections 3.D and 4.

Each of the tests and the information collected during the five sequences are recorded in the results table (curr_httpgetmt or curr_httppostmt for download and upload, respectively). A test is uniquely identified by a combination of the panelist's ID (unit_id) and the test's start time (dtime). The rows of data in this test are used to calculate the peak and 24-hour period sustained throughput per ISP.

The analysis of this raw data takes place in 3 steps:

1. Three intermediate tables are generated: tmp_httpjoin, tmp_httsustained, unit_httpgetmt_pct99. See below for a description of each of these tables' structures.
2. These intermediate tables are populated with data. See below for a description of how each of these tables are populated with data. 
3. Using the raw data from curr_httpgetmt (curr_httppostmt) and these intermediate tables, a per-panelist throughput calculation is done. The per-panelist throughput is essentially an average of the burst or sustained throughputs collected over a period of time. In particular, the average is calculated by
    a. selecting every throughput result generated by a panelist (i.e., each of the sequences for each of the tests)
    b. filtering out the results that are greater than the 99th percentile of the panelist's throughput (which is stored in unit_http(get,post)mt_pct99 
    c. replacing the remaining throughput values with the corresponding test's sustained throughput (which is stored in tmp_httpsustained). 
    d. averaging these values.

Example: Assume that these two tests remain after steps (a) and (b):

Unit A (test results for 1/1/1 9:05AM):  
Sequence 0: 7  
Sequence 1: 5  
Sequence 2: 3  
Sequence 3: 4  
Sequence 4: 6  
Sequence 5: 5  
Sustained throughput: 5  
Unit A (test results for 1/1/1 9:10AM):  
Sequence 0: 6  
Sequence 1: 4  
Sequence 2: 8  
Sequence 3: 5  
Sequence 4: 7  
Sequence 5: 6  
Sustained throughput: 6  

After step (c):  
Unit A (test results for 1/1/1 9:05AM):  
Sequence 0: 5  
Sequence 1: 5  
Sequence 2: 5  
Sequence 3: 5  
Sequence 4: 5  
Sequence 5: 5  
Unit A (test results for 1/1/1 9:10AM):  
Sequence 0: 6  
Sequence 1: 6  
Sequence 2: 6  
Sequence 3: 6  
Sequence 4: 6  
Sequence 5: 6  

After step (d):  
((5 + 5 + 5 + 5 + 5 + 5) + (6 + 6 + 6 + 6 + 6 + 6))/12 = 5.5  

4. These per-panelist throughput rates are grouped by ISP and service tier and averaged together to calculate the sustained throughput for each ISP and offered service tier.

##curr_httpgetmt:

###Summary:
This table contains the results of the download tests run by each of the units. 

###Structure:
+ unit_id: The unique identifier of the panelist performing this test.
+ dtime: The time of this test (in seconds, UTC, from epoch -- unix time).
+ target: The hostname (or IP address) of the target of this test.
+ address: The hostname (or IP address) of the panelist.
+ fetch_time: A monotonically increasing timer that times the test.
+ bytes_total: A monotonically increasing counter that records the number of bytes downloaded from the target.
+ bytes_sec: An average of the throughput (in bytes/sec) of this particular 5 second interval. 
+ bytes_sec_interval:
+ warmup_time: Not used in this analysis, but meant to limit the effect of tcp "warm-up" algorithms that might limit throughput early in a connection.
+ warmup_bytes: See warmup_time.
+ sequence: An identifier (beginning at 0) that identifies the 5 second slice of the total 30 second test represented by this row.
+ threads: The number of threads used to run this test.
+ successes: The number of successes.
+ failures: The number of failures.
+ location_id: Unknown, not used.

###Description:
A combination of unit_id and dtime uniquely identifies a test. For each test run by the user there is more than one row of data. Each row of data contains statistics about the test's progress during a 5 second window. In the normal case there will be 6 rows per test. According to the Measuring Broadband America report (page 15), the sustained throughput of a particular test is calculated from the 25-30 second window (sequence 5) while the burst speed of a particular test is calculated from the 0-5 second window (sequence 0).

##tmp_httpsustained:

###Summary:
This is a intermediate (aggregate) table that holds the calculated sustained speed for each of a panelists' tests. 

###Structure:
+ u: the unique identifier of the panelist
+ d: the test's timestamp.
+ s: the sustained speed for this test (i.e., the test results)

###Description:
See above for the FCC's description of how to calculate the sustained speed for a particular test. These calculated sustained speeds are used to populate the unit_httpgetmt_pct99 table (below) and calculate the per panelist ISP throughput.

##unit_httpgetmt_pct99:

###Summary:
This is an intermediate (aggregate) table that holds the 1st and 99th percentile of a panelist's throughput for the month. 

###Structure:
+ unit_id: The unique identifier of the panelist
+ burst_perc1: The bottom 1% of the panelist's burst speeds throughout the month
+ sustained_perc1: The bottom 1% of the panelist's sustained speeds throughout the month
+ burst_perc99: The top 1% of the panelist's burst speeds throughout the month
+ sustained_perc99: The top 1% of the panelist's sustained speeds throughout the month.

###Description:
For each of the units, this table holds the bottom and top 1% for sustained and burst throughput. See above for how the FCC defines burst and sustained. The FCC calculates the percentiles of a unit's speeds using a MySQL user defined function (UDF) called median. It is a MySQL aggregate function and accepts three parameters: 1) the column to aggregate, 2) the level of precision and 3) the percentile. More information about this UDF can be found online at [sourceforge](http://sourceforge.net/tracker/?func=detail&aid=2766201&group_id=114041&atid=667000). 
